<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Test Full API Face Upload</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    .user-card { border: 1px solid #ccc; padding: 10px; margin: 10px 0; display: flex; align-items: center; }
    .user-card img { width: 100px; height: 100px; object-fit: cover; margin-right: 10px; }
    .user-info { flex: 1; }
    .user-actions button { margin: 5px; }
    video, canvas { width: 100px; height: 75px; border: 1px solid #999; }
  </style>
</head>
<body>
  <h2>ğŸ§‘â€ğŸ’» Test Full API Face Unlock</h2>

  <h3>â• ThÃªm ngÆ°á»i má»›i</h3>
  <input type="file" id="imageInput"><br><br>
  <input type="text" id="nameInput" placeholder="TÃªn ngÆ°á»i"><br><br>
  <button onclick="upload()">ğŸ“¤ Upload tá»« file</button>
  <button onclick="capture()">ğŸ“¸ Chá»¥p tá»« webcam</button><br><br>

  <video id="video" autoplay></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <h3>ğŸ“‹ Danh sÃ¡ch ngÆ°á»i dÃ¹ng</h3>
  <div id="userList"></div>

  <script>
    const API_URL = "https://face-unlock-flask.onrender.com";

    // Load webcam
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => { video.srcObject = stream; })
      .catch(err => console.error("Webcam error:", err));

    // Upload tá»« file
    function upload() {
      const fileInput = document.getElementById("imageInput");
      const name = document.getElementById("nameInput").value;

      if (fileInput.files.length === 0 || name.trim() === "") {
        alert("Vui lÃ²ng chá»n áº£nh vÃ  nháº­p tÃªn!");
        return;
      }

      const reader = new FileReader();
      reader.onload = function () {
        sendImage(reader.result, name);
      };
      reader.readAsDataURL(fileInput.files[0]);
    }

    // Chá»¥p vÃ  gá»­i áº£nh webcam
    function capture() {
      const name = document.getElementById("nameInput").value;
      if (!name.trim()) return alert("Nháº­p tÃªn trÆ°á»›c khi chá»¥p");

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);

      const dataURL = canvas.toDataURL("image/jpeg");
      sendImage(dataURL, name);
    }

    // Gá»­i áº£nh (file hoáº·c webcam) tá»›i API
    function sendImage(imageBase64, name) {
      fetch(`${API_URL}/upload_webcam`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: name.trim(), image: imageBase64 })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message || "Upload thÃ nh cÃ´ng");
        loadUsers();
      })
      .catch(err => alert("Lá»—i: " + err));
    }

    // Táº£i danh sÃ¡ch ngÆ°á»i dÃ¹ng
    function loadUsers() {
      fetch(`${API_URL}/api/users`)
        .then(res => res.json())
        .then(users => {
          const list = document.getElementById("userList");
          list.innerHTML = "";
          users.forEach(user => {
            const div = document.createElement("div");
            div.className = "user-card";
            div.innerHTML = `
              <img src="${user.image_url}" alt="áº¢nh">
              <div class="user-info">
                <b>${user.name}</b><br>
                <input type="text" id="rename_${user._id}" placeholder="TÃªn má»›i">
              </div>
              <div class="user-actions">
                <button onclick="deleteUser('${user._id}')">ğŸ—‘ï¸ XÃ³a</button>
                <button onclick="renameUser('${user._id}')">âœï¸ Äá»•i tÃªn</button>
              </div>
            `;
            list.appendChild(div);
          });
        });
    }

    // XÃ³a user
    function deleteUser(userId) {
      if (!confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a?")) return;
      fetch(`${API_URL}/api/delete_user/${userId}`, {
        method: "DELETE"
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message || "ÄÃ£ xÃ³a");
        loadUsers();
      });
    }

    // Äá»•i tÃªn
    function renameUser(userId) {
      const newName = document.getElementById(`rename_${userId}`).value;
      if (!newName.trim()) return alert("Nháº­p tÃªn má»›i");

      fetch(`${API_URL}/api/rename_user`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId, new_name: newName.trim() })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message || "ÄÃ£ Ä‘á»•i tÃªn");
        loadUsers();
      });
    }

    // Load láº§n Ä‘áº§u
    loadUsers();
  </script>
</body>
</html>
